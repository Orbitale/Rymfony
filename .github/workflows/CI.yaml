
name: CI

on:
    push:
        branches:
            - '*'

jobs:
    build:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macOS-latest]
                rust: [stable]

        steps:
            - uses: actions/checkout@master

            - name: Set tag on release
              if: startsWith(github.ref, 'refs/tags/')
              id: vars
              run: echo ::set-output name=RELEASE_VERSION::${GITHUB_REF#refs/*/}

            - uses: actions/cache@v2
              with:
                path: |
                  ~/.cargo/registry
                  ~/.cargo/git
                  target/
                key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - uses: hecrj/setup-rust-action@v1
              with:
                  rust-version: ${{ matrix.rust }}

            - name: Build
              run: |
                mkdir -p target/artifacts/
                export _BUILDOS="${{ matrix.os }}"
                echo "${_BUILDOS/-latest/}-${GITHUB_SHA::8}-`date "+%Y-%m-%d--%H-%M-%S"`-nightly" > build_type.txt
                cargo build --release --all-targets
                mv ./target/release/rymfony ./target/artifacts/rymfony.${{ matrix.os }}

            - name: Push nightly build
              uses: actions/upload-artifact@v2
              if: github.ref == 'refs/heads/main'
              with:
                name: nightly.${{ matrix.os }}
                path: target/artifacts/rymfony.${{ matrix.os }}

            - name: Push release build
              uses: actions/upload-artifact@v2
              if: startsWith(github.ref, 'refs/tags/')
              with:
                name: ${{ steps.vars.outputs.RELEASE_VERSION }}.${{ matrix.os }}
                path: target/artifacts/rymfony.${{ matrix.os }}

    build-windows:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [windows-latest]
                rust: [stable]

        steps:
            - uses: actions/checkout@master

            - name: Set tag on release
              if: startsWith(github.ref, 'refs/tags/')
              id: vars
              run: echo ::set-output name=RELEASE_VERSION::${GITHUB_REF#refs/*/}
              shell: bash

            - uses: actions/cache@v2
              with:
                path: |
                  ~/.cargo/registry
                  ~/.cargo/git
                  %HOME%/.cargo/registry
                  %HOME%/.cargo/git
                  target/
                key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - uses: hecrj/setup-rust-action@v1
              with:
                  rust-version: ${{ matrix.rust }}

            - name: Build
              run: |
                (test-path .\target\artifacts\) ? $null : (mkdir .\target\artifacts\)
                $_BUILDOS="${{ matrix.os }}" -replace '-latest',''
                $GITHUB_SHA=$env:GITHUB_SHA.substring(0,8)
                $_DATE = Get-Date -Format "yyyy-MM-dd--HH-mm-ss"
                echo $_BUILDOS-$GITHUB_SHA-$_DATE-nightly > build_type.txt
                cargo build --release --all-targets
                move .\target\release\rymfony.exe .\target\artifacts\rymfony.${{ matrix.os }}.exe

            - name: Push nightly build
              uses: actions/upload-artifact@v2
              if: github.ref == 'refs/heads/main'
              with:
                name: nightly.${{ matrix.os }}
                path: target/artifacts/rymfony.${{ matrix.os }}.exe

            - name: Push release build
              uses: actions/upload-artifact@v2
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  name: ${{ steps.vars.outputs.RELEASE_VERSION }}.${{ matrix.os }}
                  path: target/artifacts/rymfony.${{ matrix.os }}
