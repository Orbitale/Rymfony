
name: CI

on:
    push:
        branches:
            - '*'

jobs:
    build:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macOS-latest, windows-latest]
                rust: [stable]

        steps:
            - uses: actions/checkout@master
              with:
                  submodules: true

            - name: Setup cache
              uses: actions/cache@v2
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target/release/build
                      target/release/deps
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - uses: hecrj/setup-rust-action@v1
              with:
                  rust-version: ${{ matrix.rust }}

            - name: 🏗 Build
              run: |
                  cargo build

            - name: 🚀 Cargo tests
              run: |
                  cargo test

            - name: Start server before Bats tests
              run: |
                  cargo run -- serve -d &

            - name: Set up Cygwin (windows)
              if: matrix.os != 'windows-latest'
              uses: egor-tensin/setup-cygwin@v3
              with:
                  platform: x64
                  packages: cmake python3

            - name: 🚀 Bats tests (Linux & MacOS)
              run: |
                  # We must make sure that server is up & listening
                  sleep 2
                  bash ./tests/bats/bin/bats tests

            - name: Stop server after Bats tests
              if: always()
              run: |
                  cargo run stop
